## Unity Example

### Unity Project Dependencies

- [YooAsset 2.3.x](https://www.yooasset.com/): Configure according to the official documentation
- [UniTask](https://github.com/Cysharp/UniTask/releases): Install via UPM in your project
- [FlatBuffers](https://github.com/google/flatbuffers/tree/master/net/FlatBuffers): Copy the .cs files under net/FlatBuffers into your Unity project

### Example Unity Project Structure:

```
Asset/
├── HotUpdate/       
│   └── Configs/        
│   │   └── Xls/           # Stores binaries generated by x2f     
│   └── Scripts/
│       ├── GameLogic/     # Game logic scripts
│       └── Xls/           # Stores code generated by x2f
└── Plugins/        
    ├── FlatBuffers/       # FlatBuffers library
    └── UniTask/     
```

### Data Standards
- Must include an `id` field of type `int` for data indexing.

### Table Generation Commands

The following commands are examples for macOS/Linux/WSL using backslashes `\` for line continuation.  
Windows PowerShell uses backticks \`.  
CMD doesn’t support continuation—just write a .bat script and use ^.

- Incremental Table Generation:

    ```bash
    x2f ./example/batchConvert \
    -o "/Path/To/Output" \
    --output-bin "/UnityProject/Assets/HotUpdate/Configs/Xls" \ 
    --output-csharp "/UnityProject/Assets/HotUpdate/Scripts" \
    -n Xls \
    --binary-extension bytes \ 
    --data-class-suffix DataInfo \
    --csharp \
    --csharp-unity-loader \
    --csharp-unity-loader-suffix "" \
    --table-class-suffix Table
    ```

- Full Table Generation:

    ```bash
    x2f ./example/batchConvert \
    -o "/Path/To/Output" \
    --output-bin "/UnityProject/Assets/HotUpdate/Configs/Xls" \ 
    --output-csharp "/UnityProject/Assets/HotUpdate/Scripts" \
    -n Xls \
    --binary-extension bytes \ 
    --data-class-suffix DataInfo \
    --csharp \
    --csharp-unity-loader \
    --csharp-unity-loader-suffix "" \
    --table-class-suffix Table \
    --disable-incremental
    ```

> The default value for `tableClassSuffix` and `csharpUnityLoaderSuffix` was swapped for cleaner interface code.

### Using YooAsset to Bundle Binaries

- Create a resource bundle named `TablePackage`.

AssetBundle Collector Settings:

<img src="./assets/YooAsset_example.png" width="800">

- Enable `Enable Addressable`
- Use `AddressByFileName` for addressable mode

### Example Code

```csharp
async void Start()
{
    // Load the TablePackage using your own asset loading wrapper
    await AssetLoader.DownloadPackageAsync("TablePackage");

    // Load individual tables
    await Xls.Item.Instance.LoadAsync();
    await Xls.Module.Instance.LoadAsync();

    // Load merged tables based on the merge field in $tables.xlsx
    await Xls.MergeTableLoader.LoadAllAsync();  
    // This is functionally equivalent to loading Item and Module separately

    // Fetch single row data
    var item = Xls.Item.Instance.Get(101);
    Debug.Log(item.HasValue ? item.Value.Name : "Nope");

    Debug.Log($"name: {Xls.Item.Instance.Get(101)?.Name}");
    Debug.Log($"name: {Xls.Item.Instance.Get(1)?.Name}");

    // Fetch all rows
    var items = Xls.Item.Instance.GetAll();
    foreach (var itemDataInfo in items)
    {
        Debug.Log($"id: {itemDataInfo.Id} name: {itemDataInfo.Name}");
    }

    // Access data by constant definition
    if (Xls.Module.Instance.TryGet(Xls.ModuleConst.CHAT_PANEL, out var module))
    {
        Debug.Log(module.Name);
    }
    else
    {
        Debug.LogError("Cant find chat panel");
    }

    await Xls.Domain.Instance.LoadAsync();
    // Expose FlatBuffers Root object for direct method access
    var google = Xls.Domain.Instance.Root.DomainDataInfosByKey("google");
    Debug.Log(google.HasValue ? google.Value.Ip + google.Value.Port : "Nope");
}
```

### STRICT_VERIFICATION Flag

- When `STRICT_VERIFICATION` is enabled, `LoadAsync/LoadAllAsync` will strictly validate the `file_identifier`. If mismatched, it will throw an exception. Otherwise, it just logs an error in the console.

### Assembly Definition References

- You can create asmdef files for `FlatBuffers` and `Xls`, and add references in your own project to improve compile times and modularity.

### Custom Unity Template Code

- Modify the .cs files under the `template/unity` directory as needed.

### Hot Update Suggestions

- Use `LZ4` compression for bundles to significantly reduce binary size.
